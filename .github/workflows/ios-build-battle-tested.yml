name: iOS Build (Battle-Tested)

on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 35
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üì± Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: 20
          cache: 'npm'

      - name: üõ†Ô∏è Global dependencies
        run: npm ci && npm install -g expo-cli eas-cli

      # ---------- 0. Prerequisites check ----------
      - name: üîç Verify Prerequisites  
        run: |
          echo "=== Checking Xcode version ==="
          xcodebuild -version
          echo "=== Checking iOS SDK version ==="
          xcrun --sdk iphoneos --show-sdk-version
          echo "=== Checking Expo SDK version ==="
          npx expo --version
          echo "=== Checking Swift version ==="
          swift --version

      # ---------- 1. generate ios/ (if needed) ----------
      - name: üçé Expo prebuild (iOS)
        if: ${{ !hashFiles('ios/Podfile') }}
        run: |
          npx expo prebuild --clean --platform ios \
               --non-interactive --no-install
          echo "‚úì expo prebuild finished"

      # ---------- 2. Debug + Guard (CRITICAL) ----------
      - name: üîç Debug + Guard Check
        run: |
          echo "=== iOS folder contents ==="
          ls -al ios
          echo "=== Podfile existence check ==="
          test -f ios/Podfile
          echo "‚úÖ Podfile confirmed present"

      # ---------- 3. install pods with patches ----------
      - name: üì¶ CocoaPods Install + Verify Patches
        run: |
          cd ios
          pod install --repo-update
          echo "=== Verifying ExpoModulesCore patch ==="
          if grep -q '_Nonnull' Pods/**/EXJSIInstaller.h 2>/dev/null; then
            echo "‚úÖ _Nonnull patch applied successfully"
          else
            echo "‚ö†Ô∏è  _Nonnull patch may not be needed (no EXJSIInstaller.h found)"
          fi
        env:
          CP_DISABLE_REPO_SYNC: 1   # speed-up

      # ---------- 4. Verify project structure ----------
      - name: ‚úÖ Verify Xcode workspace
        run: |
          echo "=== Workspace verification ==="
          ls -la ios/*.xcworkspace
          echo "=== Available schemes ==="
          cd ios && xcodebuild -list

      # ---------- 5. build unsigned .xcarchive ----------
      - name: üèóÔ∏è Xcode Release build
        run: |
          xcodebuild -workspace ios/PolyglotKey.xcworkspace \
                     -scheme PolyglotKey \
                     -configuration Release \
                     -sdk iphoneos \
                     -archivePath $PWD/build/PolyglotKey.xcarchive \
                     archive CODE_SIGNING_ALLOWED=NO

      # ---------- 6. artifacts ----------
      - name: üì¶ Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-archive
          path: |
            build/PolyglotKey.xcarchive
            ios/Podfile
            ios/Podfile.lock
          retention-days: 7

      - name: üìã Upload debug info on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-failure
          path: |
            ios/
            ~/Library/Logs/DiagnosticReports/
          retention-days: 3 